<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dora's Math Quest: Integer Island Expedition 🚀</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">

    <!-- MathJax for LaTeX rendering -->
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <script>
      MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']], 
          displayMath: [['$$', '$$'], ['\\[', '\\]']] 
        },
        svg: {
          fontCache: 'global'
        }
      };
    </script>
    
    <style>
        /* Custom CSS for Dora's Math Quest */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #87CEEB, #6A5ACD);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0.5rem; /* Small padding for very narrow screens */
            box-sizing: border-box;
            color: #333;
        }

        .app-container {
            background-color: #fff;
            border-radius: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            padding: 1rem; /* Adjusted padding for better mobile content display */
            max-width: 98%; /* On mobile, use almost full width */
            width: 800px; /* Base width for larger screens */
            text-align: center;
            position: relative;
            overflow-y: auto; 
            min-height: 650px;
            max-height: 95vh; 
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            border: 5px solid #4F46E5; 
        }

        @media (min-width: 768px) {
            .app-container {
                padding: 2.5rem; /* Larger padding for desktop */
                max-width: 90%; /* Allow wider expansion on desktop */
                width: 960px; /* Max width for desktop for a good reading experience */
            }
        }

        .dora-avatar {
            font-size: 6rem;
            margin-bottom: 1.5rem;
            animation: float 3s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .btn {
            @apply bg-indigo-600 text-white font-extrabold py-3 px-4 rounded-full shadow-xl transition duration-300 ease-in-out transform hover:scale-105 active:scale-95;
            min-width: 120px; 
            flex-grow: 1; 
            max-width: 250px; 
            margin: 0.4rem; 
            border: 4px solid #3730A3; 
            letter-spacing: 0.03em;
            text-transform: uppercase;
            font-size: 0.85rem; 
            white-space: normal; 
            word-break: break-word; 
        }

        @media (min-width: 768px) {
            .btn {
                min-width: 200px; 
                margin: 0.75rem;
                font-size: 1.25rem; 
                padding: 0.75rem 1.5rem; 
            }
        }

        .btn-secondary {
            @apply bg-green-600 border-green-800;
        }
        .btn-danger {
            @apply bg-red-600 border-red-800;
        }

        .section-title {
            font-size: clamp(2rem, 5vw, 4rem); /* Responsive font size */
            @apply font-extrabold text-indigo-700 mb-4 md:mb-6; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* Styles for consolidated content sections */
        .content-section {
            background-color: #f8f8ff; 
            border-radius: 1rem;
            padding: 1rem; /* Adjusted padding for content sections */
            margin-bottom: 1.5rem; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            text-align: left;
        }

        .content-section h3 {
            font-size: clamp(1.5rem, 4vw, 2.5rem); /* Responsive font size */
            @apply font-bold text-indigo-700 mb-3; 
            text-align: center; 
        }
        .content-section p {
            font-size: clamp(0.95rem, 2.5vw, 1.1rem); /* Responsive font size */
            line-height: 1.6;
            margin-bottom: 0.8rem;
            color: #444;
            text-align: left; 
            word-break: break-word; /* Ensure long words break */
            overflow-wrap: break-word; /* Ensure long words break */
        }
        .content-section .example-math {
            font-size: clamp(1.2rem, 3.5vw, 1.8rem); /* Responsive font size for math */
            padding: 0.5rem 0.75rem; /* Adjusted padding */
            margin-top: 1rem;
            margin-bottom: 1rem;
            background-color: #F3F4F6;
            border-radius: 0.75rem;
            border: 2px solid #D1D5DB;
            text-align: center; 
            overflow-x: auto; /* Allow horizontal scroll for very long equations */
            -webkit-overflow-scrolling: touch;
        }
        .content-section .emoji-display {
            font-size: clamp(2rem, 6vw, 3rem); /* Responsive font size */
            display: block;
            text-align: center;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Interactive Question Specific Styles */
        .question-item {
            background-color: #f8f8ff; /* Same as content section for consistency */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            text-align: center; /* Center question for clarity */
        }
        .question-item .question-text {
            font-size: clamp(1.2rem, 3.5vw, 1.6rem); /* Responsive font size */
            font-weight: bold;
            margin-bottom: 1rem;
            color: #222;
        }
        .question-choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* More flexible grid for choices */
            gap: 0.75rem; /* Smaller gap for mobile */
            margin-top: 1rem;
            width: 100%;
        }
        .choice-btn {
            @apply bg-purple-200 text-purple-800 font-bold py-3 px-3 rounded-lg shadow-md transition duration-200 ease-in-out hover:bg-purple-300;
            border: 2px solid #8B5CF6;
            font-size: clamp(0.9rem, 2.5vw, 1.1rem); /* Responsive font size for choices */
            min-height: 60px; /* Ensure tappable area */
            display: flex;
            justify-content: center;
            align-items: center;
            word-break: break-word;
            text-align: center;
            line-height: 1.3;
        }
        .choice-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #e0e0e0;
            color: #666;
        }
        .correct-animation {
            background-color: #D1FAE5; /* Light green */
            animation: pulse-correct 0.6s forwards;
            border-color: #10B981;
        }
        .incorrect-animation {
            background-color: #FEE2E2; /* Light red */
            animation: shake 0.6s forwards;
            border-color: #EF4444;
        }
        .skip-button {
            @apply bg-yellow-500 text-yellow-900 font-bold py-2 px-4 rounded-full shadow-md transition duration-200 ease-in-out hover:bg-yellow-600;
            border: 2px solid #D97706;
            margin-top: 1rem;
            font-size: clamp(0.8rem, 2.2vw, 1rem);
            min-width: 100px;
        }

        .feedback-message {
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 1.5rem 2rem; 
            border-radius: 2rem;
            font-size: clamp(1.5rem, 4vw, 2.5rem); 
            font-weight: bold;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
            z-index: 100;
            border: 5px solid white;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }

        .feedback-message.show {
            opacity: 1;
            visibility: visible;
        }

        /* Screen management styles */
        .screen {
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Adjust to flex-start for scrollable content */
            height: 100%; 
            width: 100%;
            overflow-y: auto; /* Make screens scrollable if content exceeds height */
            -webkit-overflow-scrolling: touch;
        }
        .screen.active {
            display: flex; 
        }
    </style>
</head>
<body>
    <div class="app-container" id="appContainer"> 
        <!-- Feedback Message Overlay -->
        <div id="feedbackMessage" class="feedback-message"></div>

        <!-- FULL LANDING PAGE: All Tutorial and Questions Content -->
        <div id="fullLandingPageContent" class="screen active"> 
            <h1 class="section-title">Dora's Math Quest: BIDMAS Expedition! 🚀</h1>
            <p class="text-xl text-gray-700 mb-8 text-center">Hey Adventurer! I'm Dora, and Integer Island needs our help! Scroll down to master BIDMAS concepts and practice problems.</p>

            <div id="tutorialSection" class="content-section">
                <h3>BIDMAS Academy! 📖</h3>
                <!-- Tutorial content will be dynamically inserted here -->
            </div>

            <div id="practiceSection" class="content-section">
                <h3>Practice Challenges! 🧠</h3>
                <p class="text-lg text-gray-600 mb-4 text-center">Answer the questions below to test your knowledge!</p>
                <!-- Interactive quiz questions will be dynamically inserted here -->
            </div>

            <button id="goToProgressButton" class="btn my-6">View Progress & Report 📈</button>
        </div>

        <!-- Progress Screen -->
        <div id="progressScreen" class="screen">
            <h2 class="section-title">Your Expedition Log! ✨</h2>
            <p class="text-xl text-gray-700 mb-4">Total Data Shards: <span id="progressPoints" class="font-bold text-blue-600">0</span></p>
            <p class="text-xl text-gray-700 mb-4">Adventure Level: <span id="levelDisplay" class="font-bold text-green-600">Beginner Explorer</span></p>
            <p class="text-xl text-gray-700 mb-4">Daily Check-in Streak: <span id="progressStreak" class="font-bold text-red-600">0</span> 🔥</p>

            <h3 class="text-3xl font-bold text-purple-600 mt-8 mb-4">Mastery Badges: 🏆</h3>
            <div id="badgesDisplay" class="flex flex-wrap justify-center gap-4 mb-8">
                <!-- Badges will be displayed here -->
            </div>

            <h3 class="text-3xl font-bold text-red-600 mt-8 mb-4">Areas to Re-Explore: 🚧</h3>
            <ul id="troubledAreasList" class="list-disc list-inside text-xl text-gray-700 text-left w-full max-w-lg mx-auto">
                <!-- Troubled areas will be listed here -->
            </ul>

            <button id="backToLandingButton" class="btn btn-danger mt-8">Back to Lessons</button>
            <button id="sendReportButton" class="btn btn-secondary mt-4">Share Report 📧</button>
        </div>
    </div>

    <script>
        // --- Global State ---
        let appState = {
            points: 0,
            level: 1,
            dailyStreak: 0,
            lastPlayedDate: null,
            badges: [], 
            troubledAreas: {}, 
            sessionHistory: [], 
        };

        // --- DOM Element References ---
        const appContainer = document.getElementById('appContainer'); 
        const fullLandingPageContent = document.getElementById('fullLandingPageContent'); 
        const tutorialSection = document.getElementById('tutorialSection'); 
        const practiceSection = document.getElementById('practiceSection'); 

        const goToProgressButton = document.getElementById('goToProgressButton'); 

        const progressScreen = document.getElementById('progressScreen');

        const pointsDisplay = document.getElementById('pointsDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const progressPoints = document.getElementById('progressPoints');
        const progressLevel = document.getElementById('progressLevel');
        const progressStreak = document.getElementById('progressStreak');
        const badgesDisplay = document.getElementById('badgesDisplay');
        const troubledAreasList = document.getElementById('troubledAreasList');

        const backToLandingButton = document.getElementById('backToLandingButton'); 
        const sendReportButton = document.getElementById('sendReportButton'); 

        const feedbackMessage = document.getElementById('feedbackMessage');

        // --- Math Content ---
        const tutorialTopics = [
            {
                id: 'bidmas_intro',
                title: 'What is BIDMAS? 🤔',
                steps: [
                    { text: 'BIDMAS is our secret code to solve math problems! It tells us the correct order to do things.', emoji: '🔑' },
                    { text: 'It stands for Brackets, Indices, Division/Multiplication, Addition/Subtraction. Let\'s break it down!', emoji: '🔍' }
                ]
            },
            {
                id: 'bidmas_brackets',
                title: 'B is for Brackets! ($()$)',
                steps: [
                    { text: 'Always solve anything INSIDE brackets first. They\'re super important!', emoji: '🚧' },
                    { text: 'Example: In $8-2\\times(4+2)$, we solve $(4+2)$ first, which is $6$.', example: '$8-2\\times(4+2) \\rightarrow 8-2\\times6$' }
                ]
            },
            {
                id: 'bidmas_indices',
                title: 'I is for Indices! ($x^2$ or $\\sqrt{}$)',
                steps: [
                    { text: 'Indices are powers (like $x^2$) or square roots ($\\sqrt{}$). Do these next!', emoji: '📈' },
                    { text: 'Example: In $(-2)^3 - 3 \\times -2$, we solve $(-2)^3$ first, which is $-8$.', example: '$(-2)^3 - 3 \\times -2 \\rightarrow -8 - 3 \\times -2$' }
                ]
            },
            {
                id: 'bidmas_division_multiplication',
                title: 'DM is for Division & Multiplication! ($\\div \\times$)',
                steps: [
                    { text: 'These two are a team! Do them from left to right as they appear.', emoji: '➡️' },
                    { text: 'Example: In $72\\div8\\times-3$, we do $72\\div8$ first, which is $9$. Then $9\\times-3$.', example: '$72\\div8\\times-3 \\rightarrow 9\\times-3$' }
                ]
            },
            {
                id: 'bidmas_addition_subtraction',
                title: 'AS is for Addition & Subtraction! ($+ - $)',
                steps: [
                    { text: 'These are also a team! Do them last, from left to right as they appear.', emoji: '✅' },
                    { text: 'Example: In $8-8+2$, we do $8-8$ first, which is $0$. Then $0+2$.', example: '$8-8+2 \\rightarrow 0+2$' }
                ]
            },
            {
                id: 'bidmas_full_example',
                title: 'Putting it all together!',
                steps: [
                    { text: 'Let\'s try a full problem: $5\\times6-3+(5-2)$.', example: '$5\\times6-3+(5-2)$' },
                    { text: '1. Brackets: $(5-2) = 3$', example: '$5\\times6-3+3$' },
                    { text: '2. Multiplication: $5\\times6 = 30$', example: '$30-3+3$' },
                    { text: '3. Subtraction/Addition (left to right): $30-3 = 27$, then $27+3 = 30$.', example: '$30-3+3 \\rightarrow 27+3 \\rightarrow 30$' },
                    { text: 'You\'ve got this, Explorer!', emoji: '🌟' }
                ]
            }
        ];

        // Quiz Questions - Now fully interactive
        const quizQuestions = [
            { id: 'q1a', topic: 'calculations', question: '$6+3\\times-4$', answer: '-6', choices: ['-6', '36', '18', '12'] },
            { id: 'q1b', topic: 'calculations', question: '$18-\\frac{12}{-3}$', answer: '22', choices: ['14', '22', '12', '10'] },
            { id: 'q1c', topic: 'calculations', question: '$8+-4-10$', answer: '-6', choices: ['4', '-6', '-8', '6'] },
            { id: 'q2b', topic: 'calculations', question: '$72\\div8\\times-3$', answer: '-27', choices: ['-27', '27', '-3', '3'] },
            { id: 'q2c', topic: 'calculations', question: '$7+(-3-4)$', answer: '0', choices: ['0', '14', '-14', '7'] },
            { id: 'q3b', topic: 'calculations', question: '$-6\\times5-2\\times-6$', answer: '-18', choices: ['-42', '-18', '18', '42'] },
            { id: 'q4c', topic: 'indices', question: 'Evaluate: $(-2)^3-3\\times-2$', answer: '-2', choices: ['-2', '14', '-10', '2'] },
            { id: 'q4b', topic: 'indices', question: 'Evaluate: $-6-4+(-3)^2$', answer: '-1', choices: ['-1', '11', '-19', '2'] },
            { id: 'q5a', topic: 'indices', question: 'Evaluate: $\\frac{-8}{2}+(-2)^2$', answer: '0', choices: ['0', '-8', '4', '-2'] },
            { id: 'q9', topic: 'word_problems', question: 'A submarine dives $100m$ ($-100$), rises $60m$ ($+60$), then dives $25m$ ($-25$). What is its final position (in meters)?', answer: '-65', choices: ['-65', '-15', '185', '35'] },
            { id: 'q10', topic: 'word_problems', question: 'Jini has $\$2075$. She makes $2$ withdrawals of $\$150$ each, then $5$ deposits of $\$60$ each. How much money does Jini have now?', answer: '2075', choices: ['1925', '2075', '2125', '1875'] },
            { id: 'q11', topic: 'word_problems', question: 'A truck holds $156L$ diesel. After $4$ days, $64L$ is left. What was the average fuel usage per day (in L)?', answer: '23', choices: ['23', '38', '15', '26'] },
            { id: 'q16', topic: 'word_problems', question: 'A snail climbs $3cm$ ($+3$), slips back $2cm$ ($-2$), climbs $4cm$ ($+4$), and slips back $1cm$ ($-1$). How far is it from the bottom of the bucket?', answer: '4', choices: ['4', '10', '2', '6'] },
            { id: 'q13a', topic: 'true_false', question: 'Is $5\\times6-3+(5-2) < 5\\times(6-3)+5-2$ True or False?', answer: 'False', choices: ['True', 'False'] },
            { id: 'q13b', topic: 'true_false', question: 'Is $2+(15\\div3)\\times1 = 2+15\\div(3\\times1)$ True or False?', answer: 'True', choices: ['True', 'False'] },
        ];


        // --- Utility Functions ---

        /**
         * Safely attempts to typeset elements with MathJax, waiting for it to be ready.
         * @param {HTMLElement[]} elements - Array of DOM elements to typeset.
         */
        function typesetIfMathJaxReady(elements) {
            if (window.MathJax && window.MathJax.startup && window.MathJax.startup.ready) {
                window.MathJax.startup.ready.then(() => {
                    // console.log("MathJax is ready, typesetting elements:", elements);
                    window.MathJax.typesetPromise(elements).catch((err) => console.error("MathJax typesetting error:", err));
                }).catch(err => console.error("MathJax startup ready promise error:", err));
            } else {
                // console.warn("MathJax or MathJax.startup.ready not available for typesetting. Retrying in 200ms...");
                setTimeout(() => typesetIfMathJaxReady(elements), 200); // Retry after a short delay
            }
        }

        /**
         * Switches the displayed screen.
         * @param {HTMLElement} screenToShow - The DOM element of the screen to display.
         */
        function showScreen(screenToShow) {
            // All 'screen' divs should be hidden by default
            const allScreens = [fullLandingPageContent, progressScreen]; 
            allScreens.forEach(screen => {
                screen.classList.remove('active');
            });

            // Show the target screen
            screenToShow.classList.add('active');

            // Scroll to top of the specific screen's scrollable content if it exists
            if (screenToShow === fullLandingPageContent) {
                appContainer.scrollTo(0, 0); 
            } else if (screenToShow === progressScreen) {
                progressScreen.scrollTo(0, 0); 
            }
            
            // Trigger MathJax typesetting for the newly displayed screen
            typesetIfMathJaxReady([screenToShow]);
        }

        /**
         * Displays a temporary feedback message.
         * @param {string} message - The message text.
         * @param {string} type - 'correct' or 'incorrect' for styling.
         */
        function displayFeedback(message, type) {
            feedbackMessage.textContent = message;
            feedbackMessage.className = 'feedback-message show';
            if (type === 'correct') {
                feedbackMessage.classList.add('bg-green-600');
                feedbackMessage.style.borderColor = '#10B981';
            } else if (type === 'incorrect') {
                feedbackMessage.classList.add('bg-red-600');
                feedbackMessage.style.borderColor = '#EF4444';
            }

            setTimeout(() => {
                feedbackMessage.classList.remove('show', 'bg-green-600', 'bg-red-600');
                feedbackMessage.style.borderColor = 'white'; 
            }, 1800);
        }

        /**
         * Saves the current app state to localStorage.
         */
        function saveAppState() {
            localStorage.setItem('doraMathQuest', JSON.stringify(appState));
        }

        /**
         * Loads the app state from localStorage and initializes missing properties.
         */
        function loadAppState() {
            const savedState = localStorage.getItem('doraMathQuest');
            if (savedState) {
                appState = JSON.parse(savedState);
                appState.dailyStreak = appState.dailyStreak || 0;
                appState.lastPlayedDate = appState.lastPlayedDate || null;
                appState.troubledAreas = appState.troubledAreas || {};
                appState.sessionHistory = appState.sessionHistory || [];
                appState.badges = appState.badges || [];
            }
            checkDailyStreak(); 
        }

        /**
         * Updates points and level displays across the app.
         */
        function updatePointsAndLevelDisplay() {
            if(pointsDisplay) pointsDisplay.textContent = appState.points;
            if(levelDisplay) levelDisplay.textContent = getLevelName(appState.level);
            if(progressPoints) progressPoints.textContent = appState.points;
            if(progressLevel) progressLevel.textContent = getLevelName(appState.level);
            updateLevel(); 
        }

        /**
         * Calculates and updates the user's adventure level.
         */
        function updateLevel() {
            const newLevel = Math.floor(appState.points / 150) + 1; 
            if (newLevel > appState.level) {
                displayFeedback(`Level Up! You reached Level ${newLevel}! 🎉`, 'correct');
                appState.level = newLevel;
            }
            if(levelDisplay) levelDisplay.textContent = getLevelName(appState.level);
            if(progressLevel) progressLevel.textContent = getLevelName(appState.level);
        }

        /**
         * Returns a descriptive name for the given level.
         * @param {number} level - The level number.
         * @returns {string} The level name.
         */
        function getLevelName(level) {
            if (level < 3) return 'Novice Explorer';
            if (level < 6) return 'Junior Navigator';
            if (level < 10) return 'Equation Expert';
            if (level < 15) return 'Formula Master';
            return 'Integer Island Legend!';
        }

        /**
         * Checks and updates the daily streak based on last played date.
         */
        function checkDailyStreak() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const todayString = today.toISOString().split('T')[0];

            if (appState.lastPlayedDate) {
                const lastPlayed = new Date(appState.lastPlayedDate);
                lastPlayed.setHours(0, 0, 0, 0);

                const oneDay = 24 * 60 * 60 * 1000; 
                const diffDays = Math.round(Math.abs((today.getTime() - lastPlayed.getTime()) / oneDay));

                if (todayString === appState.lastPlayedDate) {
                } else if (diffDays === 1) {
                    appState.dailyStreak++;
                    displayFeedback(`Streak! ${appState.dailyStreak} days in a row! 🔥`, 'correct');
                } else {
                    if (appState.dailyStreak > 0) {
                        displayFeedback('Streak Broken! Start a new one! 😔', 'incorrect');
                    }
                    appState.dailyStreak = 0;
                }
            } else {
                appState.dailyStreak = 0;
            }
            appState.lastPlayedDate = todayString;
            if(progressStreak) progressStreak.textContent = appState.dailyStreak;
            saveAppState();
        }

        /**
         * Unlocks a badge if not already earned.
         * @param {string} id - Badge ID.
         * @param {string} name - Badge display name.
         * @param {string} emoji - Badge emoji.
         */
        function unlockBadge(id, name, emoji) {
            if (!appState.badges.some(badge => badge.id === id)) {
                appState.badges.push({ id, name, emoji });
                displayFeedback(`New Badge Unlocked! ${name} ${emoji}`, 'correct');
                saveAppState();
                updateProgressScreen();
            }
        }
        
        // --- Content Generation (Consolidated) ---

        /**
         * Handles user's answer submission for an interactive question.
         * @param {string} userAnswer - The answer submitted by the user.
         * @param {object} question - The question object.
         * @param {HTMLElement} questionItemElem - The DOM element for the current question.
         */
        function handleAnswer(userAnswer, question, questionItemElem) {
            const choiceButtons = questionItemElem.querySelectorAll('.choice-btn');
            choiceButtons.forEach(btn => btn.disabled = true); // Disable all choices after selection

            const isCorrect = (userAnswer === question.answer);
            const feedbackArea = questionItemElem.querySelector('.feedback-area'); // Area to display feedback

            // Update troubled areas logic
            const sessionRecord = appState.sessionHistory[appState.sessionHistory.length - 1] || { questionsAttempted: 0, correctAnswers: 0, pointsEarned: 0, troubledTopics: [] };
            sessionRecord.questionsAttempted = (sessionRecord.questionsAttempted || 0) + 1;

            if (userAnswer === "Don't Understand") {
                displayFeedback("It's okay! Review the topics above.", "incorrect");
                feedbackArea.innerHTML = `<p class="text-red-600 mt-2 font-semibold">Review related tutorials above. The answer is: ${question.answer}</p>`;
                appState.troubledAreas[question.topic] = (appState.troubledAreas[question.topic] || 0) + 1;
                if (!sessionRecord.troubledTopics.includes(question.topic)) {
                    sessionRecord.troubledTopics.push(question.topic);
                }
            } else if (isCorrect) {
                displayFeedback("Correct! 🎉", "correct");
                feedbackArea.innerHTML = `<p class="text-green-600 mt-2 font-semibold">Correct! Well done!</p>`;
                appState.points += 25; // Award points for correct answer
                sessionRecord.correctAnswers = (sessionRecord.correctAnswers || 0) + 1;
                sessionRecord.pointsEarned = (sessionRecord.pointsEarned || 0) + 25;
                // Reset trouble for this topic if they got it right
                if (appState.troubledAreas[question.topic]) {
                    delete appState.troubledAreas[question.topic];
                }
                // Check for badges
                if (appState.points >= 100 && !appState.badges.some(b => b.id === 'first_math_master')) {
                    unlockBadge('first_math_master', 'First Math Master', '✨');
                }
                if (appState.points >= 250 && !appState.badges.some(b => b.id === 'integer_navigator')) {
                    unlockBadge('integer_navigator', 'Integer Navigator', '🧭');
                }

                // Add animation to the correct button if multiple choice
                const selectedButton = Array.from(choiceButtons).find(btn => btn.textContent === userAnswer);
                if (selectedButton) {
                    selectedButton.classList.add('correct-animation');
                }

            } else {
                displayFeedback("Incorrect. 🤔", "incorrect");
                feedbackArea.innerHTML = `<p class="text-red-600 mt-2 font-semibold">Incorrect. The answer is: ${question.answer}</p>`;
                appState.troubledAreas[question.topic] = (appState.troubledAreas[question.topic] || 0) + 1;
                if (!sessionRecord.troubledTopics.includes(question.topic)) {
                    sessionRecord.troubledTopics.push(question.topic);
                }

                // Add animation to the incorrect button if multiple choice
                const selectedButton = Array.from(choiceButtons).find(btn => btn.textContent === userAnswer);
                if (selectedButton) {
                    selectedButton.classList.add('incorrect-animation');
                }
            }
            saveAppState(); // Save state after each answer
            updatePointsAndLevelDisplay(); // Update display immediately
        }

        /**
         * Renders all tutorial and quiz content into the full landing page div.
         */
        function loadFullWorksheetContent() {
            tutorialSection.innerHTML = ''; // Clear tutorial section
            practiceSection.innerHTML = `
                <h3>Practice Challenges! 🧠</h3>
                <p class="text-lg text-gray-600 mb-4 text-center">Answer the questions below to test your knowledge!</p>
            `; // Clear practice section

            // Add tutorial content
            tutorialTopics.forEach(topic => {
                const topicSection = document.createElement('div');
                topicSection.innerHTML = `<h3>${topic.title}</h3>`;

                topic.steps.forEach(step => {
                    const stepP = document.createElement('p');
                    stepP.innerHTML = step.text;
                    topicSection.appendChild(stepP);

                    if (step.example) {
                        const exampleDiv = document.createElement('div');
                        exampleDiv.classList.add('example-math');
                        exampleDiv.innerHTML = `$$${step.example}$$`;
                        topicSection.appendChild(exampleDiv);
                    }
                    if (step.emoji) {
                        const emojiSpan = document.createElement('span');
                        emojiSpan.classList.add('emoji-display');
                        emojiSpan.innerHTML = step.emoji;
                        topicSection.appendChild(emojiSpan);
                    }
                });
                tutorialSection.appendChild(topicSection);
            });

            // Add interactive quiz questions
            quizQuestions.forEach((question, index) => {
                const questionItem = document.createElement('div');
                questionItem.classList.add('question-item');
                questionItem.setAttribute('data-question-id', question.id); // For tracking

                const questionTextElem = document.createElement('p');
                questionTextElem.classList.add('question-text');
                questionTextElem.innerHTML = `${index + 1}. ${question.question}`;
                questionItem.appendChild(questionTextElem);

                const choicesContainer = document.createElement('div');
                choicesContainer.classList.add('question-choices');

                // Shuffle choices including the correct answer
                let shuffledChoices = [...question.choices];
                for (let i = shuffledChoices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledChoices[i], shuffledChoices[j]] = [shuffledChoices[j], shuffledChoices[i]];
                }

                shuffledChoices.forEach(choice => {
                    const choiceBtn = document.createElement('button');
                    choiceBtn.classList.add('choice-btn');
                    choiceBtn.innerHTML = choice; // Use innerHTML for MathJax within choices
                    choiceBtn.addEventListener('click', () => handleAnswer(choice, question, questionItem));
                    choicesContainer.appendChild(choiceBtn);
                });

                // Add "Don't Understand" button
                const dontUnderstandBtn = document.createElement('button');
                dontUnderstandBtn.classList.add('skip-button', 'choice-btn'); // Using choice-btn for consistent styling
                dontUnderstandBtn.innerHTML = "Don't Understand 💡";
                dontUnderstandBtn.addEventListener('click', () => handleAnswer("Don't Understand", question, questionItem));
                choicesContainer.appendChild(dontUnderstandBtn);

                questionItem.appendChild(choicesContainer);

                const feedbackArea = document.createElement('div');
                feedbackArea.classList.add('feedback-area', 'mt-4'); // Area for feedback messages
                questionItem.appendChild(feedbackArea);

                practiceSection.appendChild(questionItem);
            });

            // Trigger MathJax typesetting for all the newly loaded content
            typesetIfMathJaxReady([tutorialSection, practiceSection]);

            // Start a new session history entry when the worksheet loads
            appState.sessionHistory.push({
                date: new Date().toLocaleString(),
                type: 'worksheet_practice',
                questionsAttempted: 0,
                correctAnswers: 0,
                pointsEarned: 0,
                troubledTopics: [],
                durationMinutes: 0 // Not actively timed for this "worksheet"
            });
            saveAppState();
        }

        // --- Progress Screen Logic ---
        /**
         * Updates and displays the progress screen.
         */
        function updateProgressScreen() {
            updatePointsAndLevelDisplay(); 

            // Update daily streak display immediately
            if(progressStreak) progressStreak.textContent = appState.dailyStreak;

            // Badges
            badgesDisplay.innerHTML = '';
            if (appState.badges.length === 0) {
                badgesDisplay.innerHTML = '<p class="text-gray-500 text-lg">No badges yet! Keep conquering quests!</p>';
            } else {
                appState.badges.forEach(badge => {
                    const badgeElem = document.createElement('span');
                    badgeElem.classList.add('p-3', 'bg-yellow-200', 'text-yellow-800', 'rounded-full', 'shadow-md', 'font-semibold', 'text-base', 'flex', 'items-center', 'gap-1', 'justify-center');
                    badgeElem.innerHTML = `${badge.emoji} ${badge.name}`;
                    badgesDisplay.appendChild(badgeElem);
                });
            }

            // Troubled Areas
            troubledAreasList.innerHTML = '';
            const uniqueTroubledTopics = Object.keys(appState.troubledAreas).filter(topic => appState.troubledAreas[topic] > 0);
            if (uniqueTroubledTopics.length === 0) {
                troubledAreasList.innerHTML = '<p class="text-gray-500 text-lg">No specific areas to re-explore. Excellent!</p>';
            } else {
                uniqueTroubledTopics.forEach(topic => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('mb-2');
                    listItem.textContent = `${topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} (Flagged: ${appState.troubledAreas[topic]} times)`;
                    troubledAreasList.appendChild(listItem);
                });
            }
        }

        // --- Email Export Logic ---
        /**
         * Generates and triggers a mailto link with the user's report.
         */
        function sendReport() {
            const userName = "Valued Explorer";
            let reportBody = `Hello,\n\n`;
            reportBody += `Here's an update on your progress in Dora's Math Quest: Integer Island Expedition!\n\n`;
            reportBody += `Total Data Shards: ${appState.points}\n`;
            reportBody += `Current Adventure Level: ${getLevelName(appState.level)} (Level ${appState.level})\n`;
            reportBody += `Daily Check-in Streak: ${appState.dailyStreak} 🔥\n\n`;

            reportBody += "--- Mastery Badges Earned ---\n";
            if (appState.badges.length > 0) {
                appState.badges.forEach(badge => { // Corrected appBody.badges to appState.badges
                    reportBody += `${badge.emoji} ${badge.name}\n`;
                });
            } else {
                reportBody += "No badges earned yet. Keep adventuring!\n";
            }
            reportBody += "\n";

            reportBody += "--- Areas to Re-Explore (Topics Flagged) ---\n";
            const uniqueTroubledTopics = Object.keys(appState.troubledAreas).filter(topic => appState.troubledAreas[topic] > 0);
            if (uniqueTroubledTopics.length > 0) {
                uniqueTroubledTopics.forEach(topic => {
                    reportBody += `- ${topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} (Flagged ${appState.troubledAreas[topic]} times)\n`;
                });
            } else {
                reportBody += "No specific areas needing re-exploration noted. Excellent work!\n";
            }
            reportBody += "\n";

            reportBody += "--- Recent Expedition History ---\n";
            if (appState.sessionHistory.length > 0) {
                appState.sessionHistory.forEach(session => {
                    reportBody += `\nSession Date: ${session.date}\n`;
                    reportBody += `Type: ${session.type}\n`;
                    reportBody += `Questions Attempted: ${session.questionsAttempted}\n`;
                    reportBody += `Correct Answers: ${session.correctAnswers}\n`;
                    reportBody += `Points Earned: ${session.pointsEarned} Data Shards\n`;
                    if (session.durationMinutes) {
                        reportBody += `Duration: ${session.durationMinutes} minutes\n`;
                    }
                    if (session.troubledTopics && session.troubledTopics.length > 0) {
                        reportBody += `Topics Flagged in Session: ${session.troubledTopics.map(t => t.replace(/_/g, ' ')).join(', ')}\n`;
                    }
                });
            } else {
                reportBody += "No recent quest sessions recorded.\n";
            }
            reportBody += "\n\nKeep solving mysteries and exploring with Dora!\n";

            const subject = encodeURIComponent("Dora's Math Quest: Expedition Report");
            const body = encodeURIComponent(reportBody);
            const mailtoLink = `mailto:your.email@example.com?subject=${subject}&body=${body}`;

            window.location.href = mailtoLink;
        }


        // --- Event Listeners ---
        goToProgressButton.addEventListener('click', () => {
            showScreen(progressScreen);
        });

        backToLandingButton.addEventListener('click', () => { 
            showScreen(fullLandingPageContent); 
        });

        sendReportButton.addEventListener('click', sendReport);

        // --- Initial Load ---
        window.onload = () => {
            loadAppState();
            updatePointsAndLevelDisplay();
            // Call typesetIfMathJaxReady for the initial load, which will then call loadFullWorksheetContent internally
            typesetIfMathJaxReady([fullLandingPageContent]); 
        };

    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dora's Math Quest: BIDMAS Expedition!</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f8ff; color: #333; }
        header { text-align: center; }
        section { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; background-color: white; border-radius: 10px; }
        .qnum { cursor: help; font-weight: bold; }
        .idk { margin-left: 10px; cursor: pointer; background-color: #ffd700; border: none; padding: 6px 10px; border-radius: 5px; }
        .hint-btn { margin-left: 10px; cursor: pointer; background-color: #90ee90; border: none; padding: 6px 10px; border-radius: 5px; }
        .answer-input { margin-left: 10px; width: 100px; padding: 5px; border-radius: 5px; }
        .check-btn { margin-left: 10px; cursor: pointer; background-color: #add8e6; border: none; padding: 6px 10px; border-radius: 5px; }
        .feedback { margin-left: 10px; color: green; display: none; font-weight: bold; }
        .wrong { color: red; }
        #progress-shards { font-weight: bold; }
        .hint { display: none; background-color: #fffacd; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .fun-msg { color: #ff4500; font-weight: bold; }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%; /* Could be more responsive */
            max-width: 500px;
            text-align: center;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        ü¶ã Dora's Math Quest: BIDMAS Expedition! üöÄ
        <p>Hey Dora! You're the brave adventurer Integer Island needs! Let's master BIDMAS and save the day! Scroll down for fun concepts and practice problems. üåü</p>
    </header>

    <nav>
        <a href="#basics">Go to BIDMAS Basics üìñ</a>
        <a href="#practice">Go to Practice üí™</a>
    </nav>

    <section id="progress">
        <h2>View Progress &amp; Report üìà</h2>
        <h3>Your Expedition Log! ‚ú®</h3>
        <p>Total Data Shards: <span id="progress-shards">0</span></p>
        <p>Adventure Level: <span id="adventure-level">Beginner Explorer</span></p>
        <p>Daily Check-in Streak: 0 üî•</p>
        <p>Mastery Badges: üèÜ</p>
        <p>Areas to Re-Explore: <span id="areas-to-re-explore">None</span> üöß</p>
        <button onclick="resetProgress()">Reset Progress</button>
        <a href="#basics">Back to Lessons</a>
    </section>

    <section id="basics">
        <h2>Dora's Study Corner! üìö</h2>
        <p>BIDMAS Basics: Hey Dora, BIDMAS is like a secret code for solving math puzzles! It stands for Brackets, Indices, Division/Multiplication, Addition/Subtraction. Follow this order to crack every math problem! üéâ</p>
        <ul>
            <li><strong>B</strong>rackets -&gt; () Solve these first!</li>
            <li><strong>I</strong>ndices -&gt; x¬≤ or 8¬≤ Like superpowers for numbers!</li>
            <li><strong>D</strong>ivision -&gt; √∑ or fractions</li>
            <li><strong>M</strong>ultiplication -&gt; √ó</li>
            <li><strong>A</strong>ddition -&gt; +</li>
            <li><strong>S</strong>ubtraction -&gt; -</li>
        </ul>
        <p>Example: 2 + 3 √ó 4. Do 3 √ó 4 = 12 first, then 2 + 12 = 14. You got this! üòä</p>
        <a href="#progress">Back to Progress</a>
    </section>

    <section id="practice">
        <h2>Practice Challenges! üí™</h2>
        <p>Dora, let's tackle these BIDMAS homework problems and collect shards! Each correct answer earns a shard. Get 10 to level up! üöÄ</p>
        <ol id="practice-questions">
            <li>
                <span class="qnum">1.</span> Calculate the following using the correct order of operations.
                <ul>
                    <li>a. $5 + 2 \times 6$ <input class="answer-input" data-correct="17" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint1a">Hint</button> <button class="idk" data-question="5 + 2 √ó 6">I don't know</button>
                    <div id="hint1a" class="hint">Remember BIDMAS! Multiplication before addition. $2 \times 6 = 12$, then $5 + 12 = 17$.</div></li>
                    <li>b. $20 - 15 \div 3$ <input class="answer-input" data-correct="15" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint1b">Hint</button> <button class="idk" data-question="20 - 15 √∑ 3">I don't know</button>
                    <div id="hint1b" class="hint">Division before subtraction. $15 \div 3 = 5$, then $20 - 5 = 15$.</div></li>
                    <li>c. $7 + (-12)$ <input class="answer-input" data-correct="-5" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint1c">Hint</button> <button class="idk" data-question="7 + (-12)">I don't know</button>
                    <div id="hint1c" class="hint">Adding a negative is like subtracting: $7 - 12 = -5$.</div></li>
                    <li>d. $10 - 4 + (-7)$ <input class="answer-input" data-correct="-1" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint1d">Hint</button> <button class="idk" data-question="10 - 4 + (-7)">I don't know</button>
                    <div id="hint1d" class="hint">Work from left to right: $10 - 4 = 6$, then $6 + (-7) = 6 - 7 = -1$.</div></li>
                </ul>
            </li>
            <li>
                <span class="qnum">2.</span> Evaluate the following expressions using the correct order of operations.
                <ul>
                    <li>a. $8 \times (-7)$ <input class="answer-input" data-correct="-56" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint2a">Hint</button> <button class="idk" data-question="8 √ó (-7)">I don't know</button>
                    <div id="hint2a" class="hint">A positive multiplied by a negative equals a negative. $8 \times 7 = 56$, so $8 \times (-7) = -56$.</div></li>
                    <li>b. $48 \div 6 - 9$ <input class="answer-input" data-correct="-1" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint2b">Hint</button> <button class="idk" data-question="48 √∑ 6 - 9">I don't know</button>
                    <div id="hint2b" class="hint">Division first: $48 \div 6 = 8$. Then subtract: $8 - 9 = -1$.</div></li>
                    <li>c. $15 + (-3) - 8$ <input class="answer-input" data-correct="4" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint2c">Hint</button> <button class="idk" data-question="15 + (-3) - 8">I don't know</button>
                    <div id="hint2c" class="hint">Left to right: $15 + (-3) = 12$, then $12 - 8 = 4$.</div></li>
                    <li>d. $(9 + 5) \div 7$ <input class="answer-input" data-correct="2" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint2d">Hint</button> <button class="idk" data-question="(9 + 5) √∑ 7">I don't know</button>
                    <div id="hint2d" class="hint">Brackets first: $9 + 5 = 14$. Then divide: $14 \div 7 = 2$.</div></li>
                </ul>
            </li>
            <li>
                <span class="qnum">3.</span> Calculate the following expressions using the correct order of operations.
                <ul>
                    <li>a. $-5 + 3 \times (-2)$ <input class="answer-input" data-correct="-11" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint3a">Hint</button> <button class="idk" data-question="-5 + 3 √ó (-2)">I don't know</button>
                    <div id="hint3a" class="hint">Multiply first: $3 \times (-2) = -6$. Then add: $-5 + (-6) = -11$.</div></li>
                    <li>b. $(10 - 2 \times 3) + 5$ <input class="answer-input" data-correct="9" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint3b">Hint</button> <button class="idk" data-question="(10 - 2 √ó 3) + 5">I don't know</button>
                    <div id="hint3b" class="hint">Inside brackets, multiply first: $2 \times 3 = 6$. Then $10 - 6 = 4$. Finally, $4 + 5 = 9$.</div></li>
                </ul>
            </li>
            <li value="4">
                <span class="qnum">4.</span> The expression $10 - 3 \times (8 - 12) \div 2$ is equal to: <br>
                a. $16$ b. $4$ c. $26$ d. $1$ <br>
                <input class="answer-input" data-correct="16" type="text" placeholder="Enter letter or number"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint4">Hint</button> <button class="idk" data-question="10 - 3 √ó (8 - 12) √∑ 2">I don't know</button>
                <div id="hint4" class="hint">Brackets first: $8 - 12 = -4$. Then multiply: $3 \times (-4) = -12$. Divide: $-12 \div 2 = -6$. Finally, subtract: $10 - (-6) = 10 + 6 = 16$.</div>
            </li>
            <li value="5">
                <span class="qnum">5.</span> A climber starts at an elevation of 20m, climbs 30m up, then descends 45m. Calculate their final elevation. <input class="answer-input" data-correct="5" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint5">Hint</button> <button class="idk" data-question="A climber starts at an elevation of 20m, climbs 30m up, then descends 45m. Calculate their final elevation.">I don't know</button>
                <div id="hint5" class="hint">Start: $20m$. Climbs up: $20 + 30 = 50m$. Descends: $50 - 45 = 5m$.</div>
            </li>
            <li value="6">
                <span class="qnum">6.</span> Alex claims there is no difference between $12 - 4 \times (2 + 3)$ and $12 - 4 \times 2 + 3$. Do you agree with Alex? Justify your answer with correct working. <br>
                <textarea class="answer-input" data-correct="no" style="width: 300px; height: 100px;"></textarea><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint6">Hint</button> <button class="idk" data-question="Alex claims there is no difference between 12 - 4 √ó (2 + 3) and 12 - 4 √ó 2 + 3. Do you agree? Justify with working.">I don't know</button>
                <div id="hint6" class="hint">First expression: $12 - 4 \times (2 + 3) = 12 - 4 \times 5 = 12 - 20 = -8$.<br>Second expression: $12 - 4 \times 2 + 3 = 12 - 8 + 3 = 4 + 3 = 7$.<br>Since $-8 \neq 7$, you do not agree with Alex. Brackets change the order!</div>
            </li>
            <li value="7">
                <span class="qnum">7.</span> Emily buys 2 apples at $1.50 each, 3 oranges at $0.75 each, and 1 banana at $1.25. Determine the total amount Emily has to pay. <input class="answer-input" data-correct="6.50" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hint7">Hint</button> <button class="idk" data-question="Emily buys 2 apples at $1.50 each, 3 oranges at $0.75 each, and 1 banana at $1.25. Total?">I don't know</button>
                <div id="hint7" class="hint">Apples: $2 \times 1.50 = 3.00$. Oranges: $3 \times 0.75 = 2.25$. Banana: $1.25$. Total: $3.00 + 2.25 + 1.25 = 6.50$. Multiply quantities first! üç©</div>
            </li>
        </ol>
        <button onclick="shareReport()">Share Report üìß</button>
    </section>

    <!-- The Modal -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message"></p>
        </div>
    </div>

    <script>
        let shards = 0;
        const levels = ['Beginner Explorer', 'Junior Adventurer', 'Math Master', 'BIDMAS Boss'];
        let currentLevel = 0;
        const struggledQuestions = new Set(); // To track questions where hints were asked or 'I don't know' clicked
        let addedEquationCount = 0;
        const maxExtraEquations = 5; // Maximum number of extra equations to add

        // Get the modal
        const modal = document.getElementById("myModal");
        // Get the <span> element that closes the modal
        const span = document.getElementsByClassName("close-button")[0];
        const modalMessage = document.getElementById("modal-message");

        // Function to display the modal
        function showModal(message) {
            modalMessage.textContent = message;
            modal.style.display = "flex"; // Use flex to center the content
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function copyToClipboard(text) {
            // Using a temporary textarea to copy to clipboard for broader compatibility
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showModal('Question copied to clipboard! Paste it into Grok AI (grok.x.ai) for a fun explanation!');
            } catch (err) {
                showModal('Failed to copy: ' + err);
            }
            document.body.removeChild(textarea);
        }

        // Function to safely get the question string from the associated 'idk' button or by parsing
        function getQuestionString(buttonElement) {
            // Attempt to get the question text from the data-question attribute of an associated 'idk' button.
            // This is the most reliable source if available.
            const idkButton = buttonElement.closest('li').querySelector('.idk');
            if (idkButton && idkButton.dataset.question) {
                return idkButton.dataset.question;
            }

            // Fallback if no 'idk' button with data-question is found.
            let questionLi;
            // Check if the button is within a sub-list item (e.g., Q1.a, Q2.b, Q3.a, Q3.b)
            // If its closest <li> has a parent that is a <ul>, then it's a sub-question.
            if (buttonElement.closest('li') && buttonElement.closest('li').parentElement && buttonElement.closest('li').parentElement.tagName === 'UL') {
                // The .qnum is in the parent of the <ul>, which is the main question <li>.
                questionLi = buttonElement.closest('li').parentElement.closest('li');
            } else {
                // This is a top-level question (Q4, Q5, Q6, Q7, or any dynamically added E-questions).
                // The .qnum is directly inside this <li>.
                questionLi = buttonElement.closest('li');
            }

            if (questionLi) {
                const qnumSpan = questionLi.querySelector('.qnum');
                if (qnumSpan) {
                    // Collect the text that immediately follows the .qnum span within this questionLi.
                    // This handles both simple text and potential LaTeX formatted text.
                    let textContent = '';
                    let currentNode = qnumSpan.nextSibling;
                    // Iterate through sibling nodes until an element node (like <ul> or <br>) is encountered
                    while (currentNode && currentNode.nodeType !== Node.ELEMENT_NODE) { 
                        if (currentNode.nodeType === Node.TEXT_NODE) {
                            textContent += currentNode.textContent;
                        }
                        currentNode = currentNode.nextSibling;
                    }
                    // Trim and replace multiple spaces
                    textContent = textContent.replace(/\s+/g, ' ').trim();
                    if (textContent) {
                        return textContent;
                    }
                }
            }
            return 'Unknown Question'; // Fallback if unable to determine the question text
        }

        function checkAnswer(input, btn) {
            const feedback = btn.nextElementSibling;
            let userAnswer = input.value.trim().toLowerCase();
            let correct = String(input.dataset.correct).toLowerCase(); // Ensure correct is treated as string

            let isCorrect = false;

            if (input.tagName === 'TEXTAREA') {
                if (userAnswer.includes('no')) {
                    isCorrect = true;
                }
            } else {
                // Special handling for the type of question 4 (previously 7) where 'a' or '16' are correct
                if (correct === '16' && (userAnswer === 'a' || userAnswer === '16' || userAnswer === 'a.16' || userAnswer === 'a 16')) { // Corrected for question 4
                    userAnswer = '16'; // Normalize for comparison
                }
                if (userAnswer === correct) {
                    isCorrect = true;
                }
            }

            if (isCorrect) {
                feedback.textContent = 'Awesome, Dora! You nailed it! üéâ';
                feedback.classList.remove('wrong');
                if (!input.dataset.checked) {
                    updateShards();
                    input.dataset.checked = true;
                }
            } else {
                feedback.textContent = 'Oops, not quite! Try again, you‚Äôve got this! üí´';
                feedback.classList.add('wrong');
            }
            feedback.style.display = 'inline';
        }

        // Pool of extra equations for dynamic addition
        const extraEquations = [
            {
                questionHtml: `
                    <span class="qnum">E1.</span> Calculate: $ (7 + 3) \times 2 - 5 $ <input class="answer-input" data-correct="15" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hintE1">Hint</button> <button class="idk" data-question="(7 + 3) √ó 2 - 5">I don't know</button>
                    <div id="hintE1" class="hint">Brackets first: $7 + 3 = 10$. Then multiply: $10 \times 2 = 20$. Finally, subtract: $20 - 5 = 15$.</div>
                `,
                idkQuestion: "(7 + 3) √ó 2 - 5"
            },
            {
                questionHtml: `
                    <span class="qnum">E2.</span> Calculate: $ 18 \div (6 - 3) + 4 $ <input class="answer-input" data-correct="10" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hintE2">Hint</button> <button class="idk" data-question="18 √∑ (6 - 3) + 4">I don't know</button>
                    <div id="hintE2" class="hint">Brackets first: $6 - 3 = 3$. Then divide: $18 \div 3 = 6$. Finally, add: $6 + 4 = 10$.</div>
                `,
                idkQuestion: "18 √∑ (6 - 3) + 4"
            },
            {
                questionHtml: `
                    <span class="qnum">E3.</span> Calculate: $ 4^2 + 5 \times 2 $ <input class="answer-input" data-correct="26" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hintE3">Hint</button> <button class="idk" data-question="4^2 + 5 √ó 2">I don't know</button>
                    <div id="hintE3" class="hint">Indices first: $4^2 = 16$. Then multiply: $5 \times 2 = 10$. Finally, add: $16 + 10 = 26$.</div>
                `,
                idkQuestion: "4^2 + 5 √ó 2"
            },
            {
                questionHtml: `
                    <span class="qnum">E4.</span> Calculate: $ (9 - 4)^2 - 10 $ <input class="answer-input" data-correct="15" type="text"><button class="check-btn">Check</button><span class="feedback"></span> <button class="hint-btn" data-hint="hintE4">Hint</button> <button class="idk" data-question="(9 - 4)^2 - 10">I don't know</button>
                    <div id="hintE4" class="hint">Brackets first: $9 - 4 = 5$. Then indices: $5^2 = 25$. Finally, subtract: $25 - 10 = 15$.</div>
                `,
                idkQuestion: "(9 - 4)^2 - 10"
            }
        ];

        // Function to attach event listeners to newly added question elements
        function attachEventListenersToNewQuestion(newLi) {
            const checkBtn = newLi.querySelector('.check-btn');
            const hintBtn = newLi.querySelector('.hint-btn');
            const idkBtn = newLi.querySelector('.idk');
            const answerInput = newLi.querySelector('.answer-input');

            if (checkBtn) {
                checkBtn.addEventListener('click', () => {
                    checkAnswer(answerInput, checkBtn);
                });
            }
            if (hintBtn) {
                hintBtn.addEventListener('click', () => {
                    const hintId = hintBtn.dataset.hint;
                    const hintDiv = document.getElementById(hintId);
                    if (hintDiv) {
                        hintDiv.style.display = hintDiv.style.display === 'block' ? 'none' : 'block';
                    }
                    const questionText = getQuestionString(hintBtn); // Use the helper function
                    struggledQuestions.add(questionText);
                    
                    // Add new equation if cap not reached
                    if (addedEquationCount < maxExtraEquations) {
                        addNewEquation();
                        showModal("New challenge added for extra practice!");
                    } else {
                        showModal("Max extra challenges added! Review the tutorials for more help.");
                    }
                });
            }
            if (idkBtn) {
                idkBtn.addEventListener('click', () => {
                    const q = idkBtn.dataset.question;
                    const prompt = `Explain how to solve ${q} using BIDMAS, step by step, like teaching a 13-year-old.`;
                    copyToClipboard(prompt);
                    struggledQuestions.add(q);
                });
            }
            if (answerInput) {
                answerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        // Corrected: 'input' is the current element in the forEach loop
                        const btn = input.nextElementSibling; 
                        checkAnswer(input, btn); // Pass 'input' and 'btn'
                    }
                });
            }
        }

        // Function to add a new equation dynamically
        function addNewEquation() {
            if (extraEquations.length === 0) {
                console.log("No more extra equations to add.");
                return;
            }

            const randomIndex = Math.floor(Math.random() * extraEquations.length);
            const equationToAdd = extraEquations.splice(randomIndex, 1)[0]; // Remove from pool

            const practiceQuestionsOl = document.getElementById('practice-questions');
            const newLi = document.createElement('li');
            newLi.innerHTML = equationToAdd.questionHtml;
            // Append the new question. Assign a temporary value to distinguish from initial questions.
            newLi.value = `E${addedEquationCount + 1}`; 
            practiceQuestionsOl.appendChild(newLi);

            // Re-attach event listeners to the newly added elements
            attachEventListenersToNewQuestion(newLi);
            addedEquationCount++;
        }

        // Initial attachment of event listeners to static questions
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('#practice-questions > li').forEach(li => {
                attachEventListenersToNewQuestion(li);
            });
        });

        // Event listener for IDK buttons (initial setup)
        document.querySelectorAll('.idk').forEach(btn => {
            btn.addEventListener('click', () => {
                const q = btn.dataset.question;
                const prompt = `Explain how to solve ${q} using BIDMAS, step by step, like teaching a 13-year-old.`;
                copyToClipboard(prompt);
                struggledQuestions.add(q); // Track the question
            });
        });

        // Event listener for Hint buttons (initial setup)
        document.querySelectorAll('.hint-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const hintId = btn.dataset.hint;
                const hintDiv = document.getElementById(hintId);
                hintDiv.style.display = hintDiv.style.display === 'block' ? 'none' : 'block';

                const questionText = getQuestionString(btn); // Use the helper function
                struggledQuestions.add(questionText); // Track the question

                // Add new equation if cap not reached
                if (addedEquationCount < maxExtraEquations) {
                    addNewEquation();
                    showModal("New challenge added for extra practice!");
                } else {
                    showModal("Max extra challenges added! Review the tutorials for more help.");
                }
            });
        });

        // Event listener for Check buttons (initial setup)
        document.querySelectorAll('.check-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = btn.previousElementSibling;
                checkAnswer(input, btn);
            });
        });

        // Event listener for Answer inputs (initial setup)
        document.querySelectorAll('.answer-input').forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    // Corrected: 'input' is the current element in the forEach loop
                    const btn = input.nextElementSibling; 
                    checkAnswer(input, btn); // Pass 'input' and 'btn'
                }
            });
        });

        function updateShards() {
            shards++;
            document.getElementById('progress-shards').textContent = shards;
            if (shards % 10 === 0 && currentLevel < levels.length - 1) {
                currentLevel++;
                document.getElementById('adventure-level').textContent = levels[currentLevel];
                showModal(`Woo-hoo! Level up to ${levels[currentLevel]}! You're a BIDMAS superstar, Dora! üöÄ`);
            }
        }

        function resetProgress() {
            shards = 0;
            currentLevel = 0;
            struggledQuestions.clear();
            addedEquationCount = 0;
            document.getElementById('progress-shards').textContent = shards;
            document.getElementById('adventure-level').textContent = levels[0];
            document.getElementById('areas-to-re-explore').textContent = 'None'; // Reset report area
            document.querySelectorAll('.feedback').forEach(f => {
                f.style.display = 'none';
            });
            document.querySelectorAll('.answer-input').forEach(i => {
                i.value = '';
                delete i.dataset.checked;
            });
            document.querySelectorAll('.hint').forEach(h => {
                h.style.display = 'none';
            });
            // Re-initialize original questions and remove dynamically added ones
            const practiceQuestionsOl = document.getElementById('practice-questions');
            // Remove all dynamically added list items (those without a value attribute, or with values starting with 'E')
            const initialQuestionCount = 7; 
            while (practiceQuestionsOl.children.length > initialQuestionCount) {
                practiceQuestionsOl.removeChild(practiceQuestionsOl.lastChild);
            }
            // Re-attach listeners to ensure they are fresh for existing questions if needed
            // This part is handled by the DOMContentLoaded listener on page load or by the specific attachEventListenersToNewQuestion
        }

        function shareReport() {
            const struggledList = struggledQuestions.size > 0 ? Array.from(struggledQuestions).join('; ') : 'None';
            const report = `Total Shards: ${shards}\nAdventure Level: ${levels[currentLevel]}\nDaily Check-in Streak: 0\nMastery Badges: üèÜ\nAreas to Re-Explore: ${struggledList}`;
            window.location.href = `mailto:trev2005+bilmas@gmail.com?subject=Dora's BIDMAS Report&body=${encodeURIComponent(report)}`;
        }

        // Update the displayed Areas to Re-Explore in real-time
        function updateAreasToReExploreDisplay() {
            const struggledList = struggledQuestions.size > 0 ? Array.from(struggledQuestions).join('; ') : 'None';
            document.getElementById('areas-to-re-explore').textContent = struggledList;
        }

        // Call this function whenever a question is added to struggledQuestions
        const originalAdd = struggledQuestions.add;
        struggledQuestions.add = function(item) {
            originalAdd.apply(this, arguments);
            updateAreasToReExploreDisplay();
        };
        const originalClear = struggledQuestions.clear;
        struggledQuestions.clear = function() {
            originalClear.apply(this, arguments);
            updateAreasToReExploreDisplay();
        };

        // Fix the incorrect data-correct value for question with value="7" (Emily's shopping)
        document.addEventListener('DOMContentLoaded', () => {
            const emilyQuestionInput = document.querySelector('li[value="7"] .answer-input');
            if (emilyQuestionInput) {
                emilyQuestionInput.dataset.correct = "6.50";
                const hintDiv = document.getElementById('hint7');
                 if (hintDiv) {
                    hintDiv.innerHTML = `Yummy math! Apples: $2 \\times 1.50 = 3.00$. Oranges: $3 \\times 0.75 = 2.25$. Banana: $1.25$. Total: $3.00 + 2.25 + 1.25 = 6.50$. Multiply quantities first! üç©`;
                 }
            }
            // Also ensure event listeners are set up for all initial questions
            document.querySelectorAll('#practice-questions > li').forEach(li => {
                attachEventListenersToNewQuestion(li);
            });
        });
    </script>
</body>
</html>
